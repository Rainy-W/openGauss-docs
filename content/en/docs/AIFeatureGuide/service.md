# service<a name="EN-US_TOPIC_0000001243876531"></a>

This subcommand can be used to initialize the configuration directory and start and stop background tasks.

## Initializing the Configuration Directory<a name="section47761656204915"></a>

You can run the  **gs\_dbmind service setup**  subcommand to initialize the configuration directory. This directory may contain the configuration files and logs of the DBMind. Some files in the directory are described as follows:

-   **dbmind.conf**: DBMind parameter configuration file. You can modify it using the  **gs\_dbmind set**  command or a text editor.
-   **dynamic\_config.db**: DBMind service metadata stored on the local node, including algorithm hyperparameters and monitoring thresholds. This file contains DBMind service metadata and cannot be configured by users.
-   **metric\_map.conf**: monitoring metric mapping table, which can be used to adapt to different collection platforms. For example, in DBMind, the monitored system CPU usage is named  **os\_cpu\_usage**, but a user-defined collection tool may name the CPU usage  **my\_cpu\_usage\_rate**. In this case, if you want DBMind to represent the CPU usage  **metric my\_cpu\_usage\_rate**, you need to modify this configuration item. That is, add the  **os\_cpu\_usage = my\_cpu\_usage\_rate**  configuration item for mapping. For common users, you are advised to use the collection component and solution of the DBMind. In this case, you do not need to modify the configuration file.
-   **logs**: This directory stores logs generated by the DBMind service.

You can initialize the configuration directory in interactive or non-interactive mode. For example, if the name of the configuration directory to be initialized is  **confpath**, perform the following operations:

**Interactive mode**

```
gs_dbmind service setup -c confpath --interactive
```

After running the preceding command, you can configure the configuration items in interactive mode through the CLI client.

**Non-interactive mode**

In non-interactive mode, the initialization consists of three steps: starting configuration, modifying configuration items, and initializing configuration. In the second step, you need to manually edit the configuration file by using the text editor. The procedure is as follows:

1.  Run the following command to start the configuration:

    ```
    gs_dbmind service setup -c confpath
    ```

2. After the preceding command is executed, the **dbmind.conf** configuration file is generated in the **confpath** directory. You need to use the text editor to manually modify the file. Related parameters are described as follows:

   ```
   # TSDB is used to specify the metric storage location of the monitored database system. Currently, only Prometheus is supported.
   # The mandatory parameters are the IP address and port number of Prometheus. Other parameters (such as username, password, and SSL certificate information) are optional.
   [TSDB]
   name = prometheus # The type of time-series database. Options: prometheus.
   host = # Address of time-series database.
   port = # Port to connect to time-series database.
   username = (null) # User name to connect to time-series database.
   password = (null) # Password to connect to time-series database.
   ssl_certfile = (null) # The certificate file for ssl connections.
   ssl_keyfile = (null) # Certificate private key file.
   ssl_keyfile_password = (null) # Password for ssl keyfile.
   ssl_ca_file = (null)  # CA certificate to validate requests.
   
   # METADATABASE is used to specify where the analysis results generated by DBMind are stored.
   # Currently, SQLite, openGauss, and PostgreSQL databases are supported. If the openGauss database is used, pay attention to the compatibility of the Python driver psycopg2. You can use the driver provided by openGauss, or compile or modify GUC parameters for adaptation.
   # Other information is about the connection to the database. Note that the user must have the permission to create the database.
   [METADATABASE]
   dbtype = sqlite # Database type. Options: sqlite, opengauss, postgresql.
   host = # Address of meta-data database.
   port = # Port to connect to meta-data database.
   username = # User name to connect to meta-data database.
   password = (null) # Password to connect to meta-data database.
   database = # Database name to connect to meta-data database.
   
   # WORKER is used to specify the number of worker subprocesses that can be used by DBMind. If 0 is written, adaptation is performed, that is, CPU resources are used as much as possible.
   [WORKER]
   process_num = 0  # Number of worker processes on a local node. Less than or equal to zero means adaptive.
   
   # AGENT is used to specify the information for the DBMind to connect to the openGauss Agent. By using this agent, DBMind can obtain the real-time status of the monitored instance, improving the analysis accuracy. In addition, you can deliver some change actions to the DB instance, for example, ending a slow SQL statement (depending on whether the user configured here has sufficient permissions).
   # The value of master_url is the IP address of the Agent. Because openGauss-exporter functions as the Agent, the value of master_url is the IP address of openGauss-exporter.
   # In addition, openGauss-exporter supports HTTPS. Therefore, you can specify an SSL certificate based on the configuration.
   [AGENT]
   master_url =  # The agent URL of the master node. e.g., https://127.0.0.1:9187.
   username = # Username to login the monitoring database. Credential for agent.
   password = # Password to login the monitoring database. Credential for agent.
   ssl_certfile = (null) # The certificate file for ssl connections.
   ssl_keyfile = (null) # Certificate private key file.
   ssl_keyfile_password = (null) # Password for ssl keyfile.
   ssl_ca_file = (null)  # CA certificate to validate requests.
   
   # SELF-MONITORING is used to configure parameters for monitoring database instances.
   # detection_interval indicates the execution frequency of the periodic check task, in seconds.
   # last_detection_time indicates the length of the latest data used by each check task.
   # forecasting_future_time indicates a length of a future time predicted by the time series forecast feature.
   # golden_kpi indicates the monitoring metric that needs to be focused on.
   # result_storage_retention indicates the maximum storage duration of diagnosis results.
   [SELF-MONITORING]
   detection_interval = 600  # Unit is second. The interval for performing health examination on the openGauss through monitoring metrics.
   last_detection_time = 600  # Unit is second. The time for last detection.
   forecasting_future_time = 3600  # Unit is second. How long the KPI in the future for forecasting. Meanwhile, this is the period for the forecast.
   # The following golden_kpi of monitoring system is vital.
   golden_kpi = os_cpu_usage, os_mem_usage, os_disk_usage, gaussdb_qps_by_instance  # DBMind only measures and detects the golden metrics in the anomaly detection processing.
   result_storage_retention = 604800  # Unit is second. How long should the results retain? If retention is more than the threshold, DBMind will delete them.
   
   # SELF-OPTIMIZATION is used to modify the following parameters to intervene the DBMind optimization result. Generally, the default values are used.
   # optimization_interval: interval for executing optimization tasks.
   # max_reserved_period: maximum storage duration of optimization results.
   # max_index_num: upper limit of the recommended index result.
   # max_index_storage: upper limit of the disk space occupied by the recommended index page.
   # max_template_num: maximum number of SQL statements recorded in the SQL template recommended for the index.
   # kill_slow_query: determines whether to enable automatic scanning and killing of slow SQL statements. If this function is enabled, you can run the set subcommand to set the threshold, for example, 70 seconds. The value must be a positive integer, in seconds.
   # gs_dbmind set slow_sql_threshold max_elapsed_time 70
   [SELF-OPTIMIZATION]
   optimization_interval = 86400  # Unit is second. The interval for generating report.
   max_reserved_period = 100 # Unit is day. Maximum retention time.
   max_index_num = 10 # Maximum number of advised indexes.
   max_index_storage = 100 # Unit is MB.
   max_template_num = 5000 # Maximum number of templates.
   kill_slow_query = false  # Whether to actively check and kill slow query. The default elapsed time of a slow query to be killed is 1 minute.
   
   # LOG indicates the DBMind log information.
   [LOG]
   maxbytes = 10485760 # Default is 10Mb. Maximum size of a single log file. If maxbytes is zero, the file grows indefinitely.
   backupcount = 1 # Number of backups of log files.
   level = INFO  # Options: DEBUG, INFO, WARNING, ERROR.
   
   # The following information is displayed when you perform interactive configuration. You do not need to configure it.
   [COMMENT]
   worker = The form of executing compute-intensive tasks. Tasks can be executed locally or distributed to multiple nodes for execution.
   tsdb = Configure the data source for time series data, which come from monitoring the openGauss instance.
   metadatabase = Configure the database to record meta-data, which the database can store meta-data for the forecasting and diagnosis process. The database should be an openGauss instance.
   self-monitoring = Set up parameters for monitoring and diagnosing openGauss instance.
   self-optimization = Set up parameters for openGauss optimization.
   
   ```

3. After manually modifying the preceding parameters, initialize the configuration items. In this phase, DBMind preliminarily checks the correctness of configuration items, initializes the structure and content of the metadata database table for storing result data, and encrypts the plaintext passwords in the configuration items.

   ```
   gs_dbmind service setup --initialize -c confpath
   ```

4. Start the DBMind background service based on the configuration directory.

>![](public_sys-resources/icon-note.gif) **NOTE:** 
>1. The comments in the configuration file are used to prompt users in interactive mode. Do not manually modify or delete the comments.
>2. Make sure that the value of the configuration item and the comment are separated by a space. Otherwise, the system regards the comment as the value of the configuration item.
>3. If special characters in a configuration item need to be escaped, use the percent sign \( %\) to escape the special characters. For example, if the password is  **password %**, use the percent sign \( %\) to escape the special characters, that is,  **password %%**.

## Starting a Service<a name="section165401522192514"></a>

After the configuration directory is initialized, you can start the DBMind background service based on the configuration directory. For example, if the configuration directory is  **confpath**, run the following command:

```
gs_dbmind service start -c confpath
```

After the preceding command is executed, the system displays a message indicating that the service has been started. If no additional parameter is specified, this command starts all background tasks by default. If you want to start only one background task, add the  **--only-run**  option. For example, if you only want to start the slow SQL root cause analysis service, run the following command:

```
gs_dbmind service start -c confpath --only-run slow_query_diagnosis
```

## Stopping a Service<a name="section5774204123013"></a>

Similar to starting a service, stopping a service has a simpler command line structure. You only need to specify the address of the configuration directory. For example, if the configuration directory is  **confpath**, run the following command:

```
gs_dbmind service stop -c confpath
```

The DBMind service automatically exits after the running task is complete in the background.

>![](public_sys-resources/icon-caution.gif) **CAUTION:** 
>-   The metabase user in  **\[METADATABASE\]**  must have the permission to create tables and insert and update data in the database. Otherwise, an exception will occur during tool execution.
>-   Currently, multiple services cannot be started separately using the same configuration file.
>-   The tool provides the  **requirement.txt**  file. You can use this file to install required third-party dependencies.

## Command Reference<a name="section272822583215"></a>

You can use the  **--help**  option to obtain the help information about this mode. For example:

```
gs_dbmind service --help
```

```
usage: service [-h] -c DIRECTORY [--only-run {slow_query_diagnosis,forecast}] [--interactive | --initialize] {setup,start,stop}

positional arguments:
  {setup,start,stop}
                        perform an action for service

optional arguments:
  -h, --help            show this help message and exit
  -c DIRECTORY, --conf DIRECTORY
                        set the directory of configuration files
  --only-run {slow_query_diagnosis,forecast}
                        explicitly set a certain task running in the backend
  --interactive         configure and initialize with interactive mode
  --initialize          initialize and check configurations after configuring.
```

**Table  1**  Parameters of the gs\_dbmind service subcommand

<a name="en-us_topic_0283137337_table628178124515"></a>
<table><thead align="left"><tr id="en-us_topic_0283137337_row162968174512"><th class="cellrowborder" valign="top" width="33.3033303330333%" id="mcps1.2.4.1.1"><p id="en-us_topic_0283137337_p1129138144517"><a name="en-us_topic_0283137337_p1129138144517"></a><a name="en-us_topic_0283137337_p1129138144517"></a>Parameter</p>
</th>
<th class="cellrowborder" valign="top" width="33.36333633363336%" id="mcps1.2.4.1.2"><p id="en-us_topic_0283137337_p2029181454"><a name="en-us_topic_0283137337_p2029181454"></a><a name="en-us_topic_0283137337_p2029181454"></a>Description</p>
</th>
<th class="cellrowborder" valign="top" width="33.33333333333333%" id="mcps1.2.4.1.3"><p id="en-us_topic_0283137337_p6291382451"><a name="en-us_topic_0283137337_p6291382451"></a><a name="en-us_topic_0283137337_p6291382451"></a>Value Range</p>
</th>
</tr>
</thead>
<tbody><tr id="row16616112314312"><td class="cellrowborder" valign="top" width="33.3033303330333%" headers="mcps1.2.4.1.1 "><p id="p6616122313314"><a name="p6616122313314"></a><a name="p6616122313314"></a>action</p>
</td>
<td class="cellrowborder" valign="top" width="33.36333633363336%" headers="mcps1.2.4.1.2 "><p id="p5616423334"><a name="p5616423334"></a><a name="p5616423334"></a>Action parameter</p>
</td>
<td class="cellrowborder" valign="top" width="33.33333333333333%" headers="mcps1.2.4.1.3 "><a name="ul613179154816"></a><a name="ul613179154816"></a><ul id="ul613179154816"><li><strong id="b191741617399"><a name="b191741617399"></a><a name="b191741617399"></a>setup</strong>: initializes configuration directory.</li><li><strong id="b106913193396"><a name="b106913193396"></a><a name="b106913193396"></a>start</strong>: starts a service.</li><li><strong id="b17663021153920"><a name="b17663021153920"></a><a name="b17663021153920"></a>stop</strong>: stops a service.</li></ul>
</td>
</tr>
<tr id="row185495841018"><td class="cellrowborder" valign="top" width="33.3033303330333%" headers="mcps1.2.4.1.1 "><p id="p116122412518"><a name="p116122412518"></a><a name="p116122412518"></a>-c, --conf</p>
</td>
<td class="cellrowborder" valign="top" width="33.36333633363336%" headers="mcps1.2.4.1.2 "><p id="p184721720498"><a name="p184721720498"></a><a name="p184721720498"></a>Configuration file directory</p>
</td>
<td class="cellrowborder" valign="top" width="33.33333333333333%" headers="mcps1.2.4.1.3 "><p id="p7214115063313"><a name="p7214115063313"></a><a name="p7214115063313"></a>-</p>
</td>
</tr>
<tr id="row105517375810"><td class="cellrowborder" valign="top" width="33.3033303330333%" headers="mcps1.2.4.1.1 "><p id="p195619371187"><a name="p195619371187"></a><a name="p195619371187"></a>--initialize</p>
</td>
<td class="cellrowborder" valign="top" width="33.36333633363336%" headers="mcps1.2.4.1.2 "><p id="p1561937283"><a name="p1561937283"></a><a name="p1561937283"></a>Initializes configuration parameters.</p>
</td>
<td class="cellrowborder" valign="top" width="33.33333333333333%" headers="mcps1.2.4.1.3 "><p id="p113091138786"><a name="p113091138786"></a><a name="p113091138786"></a>-</p>
</td>
</tr>
<tr id="row03641458113510"><td class="cellrowborder" valign="top" width="33.3033303330333%" headers="mcps1.2.4.1.1 "><p id="p113642586354"><a name="p113642586354"></a><a name="p113642586354"></a>--interactive</p>
</td>
<td class="cellrowborder" valign="top" width="33.36333633363336%" headers="mcps1.2.4.1.2 "><p id="p133651958103518"><a name="p133651958103518"></a><a name="p133651958103518"></a>Configures parameters in interactive mode.</p>
</td>
<td class="cellrowborder" valign="top" width="33.33333333333333%" headers="mcps1.2.4.1.3 "><p id="p1136545823511"><a name="p1136545823511"></a><a name="p1136545823511"></a>-</p>
</td>
</tr>
<tr id="row106196521215"><td class="cellrowborder" valign="top" width="33.3033303330333%" headers="mcps1.2.4.1.1 "><p id="p27171031065"><a name="p27171031065"></a><a name="p27171031065"></a>--only-run</p>
</td>
<td class="cellrowborder" valign="top" width="33.36333633363336%" headers="mcps1.2.4.1.2 "><p id="p161918501220"><a name="p161918501220"></a><a name="p161918501220"></a>Selects the module to be run only.</p>
</td>
<td class="cellrowborder" valign="top" width="33.33333333333333%" headers="mcps1.2.4.1.3 "><a name="ul9105143317480"></a><a name="ul9105143317480"></a><ul id="ul9105143317480"><li><strong id="b3613820412"><a name="b3613820412"></a><a name="b3613820412"></a>forecast</strong>: prediction module.</li><li><strong id="b4504852124019"><a name="b4504852124019"></a><a name="b4504852124019"></a>slow_query_diagnosis</strong>: root cause analysis module for slow SQL statements.</li></ul>
</td>
</tr>
<tr id="en-us_topic_0283137337_row162915844513"><td class="cellrowborder" valign="top" width="33.3033303330333%" headers="mcps1.2.4.1.1 "><p id="en-us_topic_0283137337_p132968134510"><a name="en-us_topic_0283137337_p132968134510"></a><a name="en-us_topic_0283137337_p132968134510"></a>-h, --help</p>
</td>
<td class="cellrowborder" valign="top" width="33.36333633363336%" headers="mcps1.2.4.1.2 "><p id="en-us_topic_0283137337_p152474092416"><a name="en-us_topic_0283137337_p152474092416"></a><a name="en-us_topic_0283137337_p152474092416"></a>Help information</p>
</td>
<td class="cellrowborder" valign="top" width="33.33333333333333%" headers="mcps1.2.4.1.3 "><p id="en-us_topic_0283137337_p94668717174"><a name="en-us_topic_0283137337_p94668717174"></a><a name="en-us_topic_0283137337_p94668717174"></a>-</p>
</td>
</tr>
</tbody>
</table>
