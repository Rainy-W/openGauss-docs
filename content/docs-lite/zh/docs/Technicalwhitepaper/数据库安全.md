# 数据库安全<a name="ZH-CN_CONCEPT_0289895649"></a>

## 访问控制<a name="zh-cn_concept_0283139021_section1518355319485"></a>

管理用户对数据库的访问控制权限，涵盖数据库系统权限和对象权限。

支持基于角色的访问控制机制，将角色和权限关联起来，通过将权限赋予给对应的角色，再将角色授予给用户，可实现用户访问控制权限管理。其中登录访问控制通过用户标识和认证技术来共同实现，而对象访问控制则基于用户在对象上的权限，通过对象权限检查实现对象访问控制。用户为相关的数据库用户分配完成任务所需要的最小权限从而将数据库使用风险降到最低。

支持三权分立权限访问控制模型，数据库角色可分为系统管理员、安全管理员和审计管理员。其中安全管理员负责创建和管理用户，系统管理员负责授予和撤销用户权限，审计管理员负责审计所有用户的行为。

默认情况下，使用基于角色的访问控制模型。客户可通过设置参数来选择是否开启三权分立控制模型。

## 控制权和访问权分离<a name="zh-cn_concept_0283139021_section74261220114919"></a>

针对系统管理员用户，实现表对象的控制权和访问权分离，提高普通用户数据安全性，限制管理员对象访问权限。

该特性适用于如下场景，即对于有多个业务部门的企业，各部门间使用不同的数据库用户进行业务操作，同时存在同级别的数据库维护部门使用数据库管理员进行运维操作，业务部门希望在未经授权的情况下，管理员用户只能对各部门的数据进行控制操作（DROP、ALTER、TRUNCATE），但是不能进行访问操作（INSERT、DELETE、UPDATE、SELECT、COPY）。即针对管理员用户，表对象的控制权和访问权分离，提高用户数据的安全性。

系统管理员可以在创建用户时指定INDEPENDENT属性，表示该用户为私有用户。针对该用户的对象，数据库管理员（包含初始用户和其他管理员用户）在未经其授权前，只能进行控制操作（DROP、ALTER、TRUNCATE），无权进行INSERT、DELETE、SELECT、UPDATE、COPY、GRANT、REVOKE、ALTER  OWNER操作。

## 数据库内置角色权限管理<a name="section210351882916"></a>

openGauss提供了一组默认角色，以gs\_role\_开头命名。它们提供对特定的、通常需要高权限的操作的访问，可以将这些角色GRANT给数据库内的其他用户或角色，让这些用户能够使用特定的功能。在授予这些角色时应当非常小心，以确保它们被用在需要的地方。[表1](#table2118117460)描述了内置角色允许的权限范围：

**表 1**  内置角色权限说明

<a name="table2118117460"></a>
<table><thead align="left"><tr id="row142101115461"><th class="cellrowborder" valign="top" width="17.44%" id="mcps1.2.3.1.1"><p id="p152141116461"><a name="p152141116461"></a><a name="p152141116461"></a>角色</p>
</th>
<th class="cellrowborder" valign="top" width="82.56%" id="mcps1.2.3.1.2"><p id="p18211117468"><a name="p18211117468"></a><a name="p18211117468"></a>权限描述</p>
</th>
</tr>
</thead>
<tbody><tr id="row132011124611"><td class="cellrowborder" valign="top" width="17.44%" headers="mcps1.2.3.1.1 "><p id="p132161115462"><a name="p132161115462"></a><a name="p132161115462"></a>gs_role_copy_files</p>
</td>
<td class="cellrowborder" valign="top" width="82.56%" headers="mcps1.2.3.1.2 "><p id="p42101120469"><a name="p42101120469"></a><a name="p42101120469"></a>具有执行copy … to/from filename 的权限，但需要先打开GUC参数enable_copy_server_files。</p>
</td>
</tr>
<tr id="row13218113465"><td class="cellrowborder" valign="top" width="17.44%" headers="mcps1.2.3.1.1 "><p id="p122117468"><a name="p122117468"></a><a name="p122117468"></a>gs_role_signal_backend</p>
</td>
<td class="cellrowborder" valign="top" width="82.56%" headers="mcps1.2.3.1.2 "><p id="p112101115462"><a name="p112101115462"></a><a name="p112101115462"></a>具有调用函数pg_cancel_backend、pg_terminate_backend和pg_terminate_session来取消或终止其他会话的权限，但不能操作属于初始用户和PERSISTENCE用户的会话。</p>
</td>
</tr>
<tr id="row182161164616"><td class="cellrowborder" valign="top" width="17.44%" headers="mcps1.2.3.1.1 "><p id="p15271114460"><a name="p15271114460"></a><a name="p15271114460"></a>gs_role_tablespace</p>
</td>
<td class="cellrowborder" valign="top" width="82.56%" headers="mcps1.2.3.1.2 "><p id="p1921011184615"><a name="p1921011184615"></a><a name="p1921011184615"></a>具有创建表空间（tablespace）的权限。</p>
</td>
</tr>
<tr id="row2261194613"><td class="cellrowborder" valign="top" width="17.44%" headers="mcps1.2.3.1.1 "><p id="p152191113468"><a name="p152191113468"></a><a name="p152191113468"></a>gs_role_replication</p>
</td>
<td class="cellrowborder" valign="top" width="82.56%" headers="mcps1.2.3.1.2 "><p id="p6271194616"><a name="p6271194616"></a><a name="p6271194616"></a>具有调用逻辑复制相关函数的权限，例如kill_snapshot、pg_create_logical_replication_slot、pg_create_physical_replication_slot、pg_drop_replication_slot、pg_replication_slot_advance、pg_create_physical_replication_slot_extern、pg_logical_slot_get_changes、pg_logical_slot_peek_changes，pg_logical_slot_get_binary_changes、pg_logical_slot_peek_binary_changes。</p>
</td>
</tr>
<tr id="row132201154612"><td class="cellrowborder" valign="top" width="17.44%" headers="mcps1.2.3.1.1 "><p id="p12141118462"><a name="p12141118462"></a><a name="p12141118462"></a>gs_role_account_lock</p>
</td>
<td class="cellrowborder" valign="top" width="82.56%" headers="mcps1.2.3.1.2 "><p id="p829117463"><a name="p829117463"></a><a name="p829117463"></a>具有加解锁用户的权限，但不能加解锁初始用户和PERSISTENCE用户。</p>
</td>
</tr>
<tr id="row0460611191614"><td class="cellrowborder" valign="top" width="17.44%" headers="mcps1.2.3.1.1 "><p id="p64601118162"><a name="p64601118162"></a><a name="p64601118162"></a>gs_role_directory_create</p>
</td>
<td class="cellrowborder" valign="top" width="82.56%" headers="mcps1.2.3.1.2 "><p id="p17460311141616"><a name="p17460311141616"></a><a name="p17460311141616"></a>具有执行创建directory对象的权限，但需要先打开GUC参数enable_access_server_directory。</p>
</td>
</tr>
<tr id="row10679131511613"><td class="cellrowborder" valign="top" width="17.44%" headers="mcps1.2.3.1.1 "><p id="p96791115121616"><a name="p96791115121616"></a><a name="p96791115121616"></a>gs_role_directory_drop</p>
</td>
<td class="cellrowborder" valign="top" width="82.56%" headers="mcps1.2.3.1.2 "><p id="p14679111519168"><a name="p14679111519168"></a><a name="p14679111519168"></a>具有执行删除directory对象的权限，但需要先打开GUC参数enable_access_server_directory。</p>
</td>
</tr>
</tbody>
</table>

## 数据库加密认证<a name="zh-cn_concept_0283139021_section5666740124910"></a>

采用基于RFC5802机制的口令加密认证方法。

加密认证过程中采用单向Hash不可逆加密算法PBKDF2，可有效防止彩虹攻击。

创建用户所设置的口令被加密存储在系统表中。整个认证过程中口令加密存储和传输，通过计算相应的hash值并与服务端存储的值比较来进行正确性校验。

统一加密认证过程中的消息处理流程，可有效防止攻击者通过抓取报文猜解用户名或者口令的正确性。

## 数据库审计<a name="zh-cn_concept_0283139021_section1544614711502"></a>

审计日志记录用户对数据库的启停、连接、DDL、DML、DCL等操作。审计日志机制主要增强数据库系统对非法操作的追溯及举证能力。

用户可以通过参数配置对哪些语句或操作记录审计日志。

审计日志记录事件的时间、类型、执行结果、用户名、数据库、连接信息、数据库对象、数据库实例名称和端口号以及详细信息。支持按起止时间段查询审计日志，并根据记录的字段进行筛选。

数据库安全管理员可以利用这些日志信息，重现导致数据库现状的一系列事件，找出非法操作的用户、时间和内容等。

## 网络通信安全特性<a name="zh-cn_concept_0283139021_section12318192310500"></a>

支持通过SSL加密客户端和服务器之间的通信数据，保证客户的客户端与服务器通信安全。

采用TLS 1.2协议标准，并使用安全强度较高的加密算法套件，支持的加密算法套件如[表2](#table13251121491017)所示。

**表 2**  加密算法套件

<a name="table13251121491017"></a>
<table><thead align="left"><tr id="row1625261412109"><th class="cellrowborder" valign="top" width="37.940000000000005%" id="mcps1.2.4.1.1"><p id="p99755175105"><a name="p99755175105"></a><a name="p99755175105"></a>OpenSSL套件名</p>
</th>
<th class="cellrowborder" valign="top" width="47.25%" id="mcps1.2.4.1.2"><p id="p119751717121010"><a name="p119751717121010"></a><a name="p119751717121010"></a>IANA套件名</p>
</th>
<th class="cellrowborder" valign="top" width="14.81%" id="mcps1.2.4.1.3"><p id="p15594635152615"><a name="p15594635152615"></a><a name="p15594635152615"></a>安全程度</p>
</th>
</tr>
</thead>
<tbody><tr id="row313281911346"><td class="cellrowborder" valign="top" width="37.940000000000005%" headers="mcps1.2.4.1.1 "><p id="p131331119183419"><a name="p131331119183419"></a><a name="p131331119183419"></a>ECDHE-RSA-AES128-GCM-SHA256</p>
</td>
<td class="cellrowborder" valign="top" width="47.25%" headers="mcps1.2.4.1.2 "><p id="p11133101914340"><a name="p11133101914340"></a><a name="p11133101914340"></a>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</p>
</td>
<td class="cellrowborder" valign="top" width="14.81%" headers="mcps1.2.4.1.3 "><p id="p1413381911349"><a name="p1413381911349"></a><a name="p1413381911349"></a>HIGH</p>
</td>
</tr>
<tr id="row19615113518261"><td class="cellrowborder" valign="top" width="37.940000000000005%" headers="mcps1.2.4.1.1 "><p id="p66166355269"><a name="p66166355269"></a><a name="p66166355269"></a>ECDHE-RSA-AES256-GCM-SHA384</p>
</td>
<td class="cellrowborder" valign="top" width="47.25%" headers="mcps1.2.4.1.2 "><p id="p1761653522615"><a name="p1761653522615"></a><a name="p1761653522615"></a>TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</p>
</td>
<td class="cellrowborder" valign="top" width="14.81%" headers="mcps1.2.4.1.3 "><p id="p261633515262"><a name="p261633515262"></a><a name="p261633515262"></a>HIGH</p>
</td>
</tr>
<tr id="row031613406345"><td class="cellrowborder" valign="top" width="37.940000000000005%" headers="mcps1.2.4.1.1 "><p id="p2031624043411"><a name="p2031624043411"></a><a name="p2031624043411"></a>ECDHE-ECDSA-AES128-GCM-SHA256</p>
</td>
<td class="cellrowborder" valign="top" width="47.25%" headers="mcps1.2.4.1.2 "><p id="p731694013418"><a name="p731694013418"></a><a name="p731694013418"></a>TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256</p>
</td>
<td class="cellrowborder" valign="top" width="14.81%" headers="mcps1.2.4.1.3 "><p id="p14316154033412"><a name="p14316154033412"></a><a name="p14316154033412"></a>HIGH</p>
</td>
</tr>
<tr id="row1723517434266"><td class="cellrowborder" valign="top" width="37.940000000000005%" headers="mcps1.2.4.1.1 "><p id="p7236204382616"><a name="p7236204382616"></a><a name="p7236204382616"></a>ECDHE-ECDSA-AES256-GCM-SHA384</p>
</td>
<td class="cellrowborder" valign="top" width="47.25%" headers="mcps1.2.4.1.2 "><p id="p17236164312261"><a name="p17236164312261"></a><a name="p17236164312261"></a>TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384</p>
</td>
<td class="cellrowborder" valign="top" width="14.81%" headers="mcps1.2.4.1.3 "><p id="p19236144315263"><a name="p19236144315263"></a><a name="p19236144315263"></a>HIGH</p>
</td>
</tr>
</tbody>
</table>

## 行级访问控制<a name="zh-cn_concept_0283139021_section135874520509"></a>

行级访问控制特性将数据库访问粒度控制到数据表行级别，使数据库达到行级访问控制的能力。不同用户执行相同的SQL查询操作，按照行访问控制策略，读取到的结果可能是不同的。

用户可以在数据表创建行访问控制（Row  Level Security）策略，该策略是指针对特定数据库用户、特定SQL操作生效的表达式。当数据库用户对数据表访问时，若SQL满足数据表特定的Row  Level Security策略，在查询优化阶段将满足条件的表达式，按照属性（PERMISSIVE |  RESTRICTIVE）类型，通过AND或OR方式拼接，应用到执行计划上。

行级访问控制的目的是控制表中行级数据可见性，通过在数据表上预定义Filter，在查询优化阶段将满足条件的表达式应用到执行计划上，影响最终的执行结果。当前行级访问控制支持的SQL语句包括SELECT，UPDATE，DELETE。

## 资源标签<a name="section7656163019424"></a>

资源标签（Resource Label）特性通过将数据库资源按照用户自定义的方式划分，实现资源分类管理的目的。管理员可以通过配置资源标签统一地为一组数据库资源进行安全策略的配置如审计或数据脱敏。

资源标签能够将数据库资源按照“特征”、“作用场景”等分组归类，对指定资源标签的管理操作即对标签范围下所有的数据库资源的管理操作，能够大大降低策略配置的复杂度和信息冗余度，提高管理效率。

当前资源标签所支持的数据库资源类型包括：SCHEMA、TABLE、COLUMN、VIEW、FUNCTION。

## 动态数据脱敏<a name="section7123124654113"></a>

为了在一定程度上限制非授权用户对隐私数据的窥探，可以利用动态数据脱敏（Dynamic Data Masking）特性保护用户隐私数据。在非授权用户访问配置了动态数据脱敏策略的数据时，数据库将返回脱敏后的数据而达到对隐私数据保护的目的。

管理员可以在数据列上创建动态数据脱敏策略，该策略指出针对特定用户场景应采取何种数据脱敏方式。在开启动态数据脱敏功能后，当用户访问敏感列数据时，系统将用户身份信息例如：访问IP、客户端工具、用户名来匹配相应的脱敏策略，在匹配成功后将根据脱敏策略对访问列的查询结果实施数据脱敏。

动态数据脱敏的目的是在不改变源数据的前提下，通过在脱敏策略上配置针对的用户场景（FILTER）、指定的敏感列标签（LABEL）和对应的脱敏方式（MASKING FUNCTION）来灵活地进行隐私数据保护。

## 统一审计<a name="section1672052375210"></a>

统一审计（Unified Auditing）利用策略和条件在数据库内部有选择地进行审计，管理员可以对数据库资源或资源标签统一地配置审计策略，从而达到简化管理、针对性地生成审计日志、减少审计日志冗余、提高管理效率的目的。

管理员可以定制化的为操作行为或数据库资源配置审计策略，该策略针对特定的用户场景、用户行为或数据库资源进行审计。在开启了统一审计功能后，当用户访问数据库时，系统将根据用户身份信息如：访问IP、客户端工具、用户名来匹配相应的统一审计策略，之后根据策略信息对用户行为按照访问资源（LABEL）和用户操作类型（DML | DDL）进行统一审计。

统一审计的目的是将现有的传统审计行为转变为针对性的跟踪审计行为，将目标之外的行为排除在审计之外，从而简化了管理，提高了数据库生成审计数据的安全性。

## 用户口令强度校验机制<a name="section465673171713"></a>

为了加固客户账户和数据的安全，禁止设置过低强度的口令，当初始化数据库、创建用户、修改用户时需要指定密码。密码必须满足强度校验，否则会提示用户重新输入密码。

账户密码复杂度对用户密码大小写字母、数字、特殊字符的最少个数，最大最小长度，不能和用户名、用户名倒写相同，不能是弱口令等进行了限制，从而增强了用户账户的安全性。

其中弱口令指的是强度较低，容易被破解的密码，对于不同的用户或群体，弱口令的定义可能会有所区别，用户需要自己添加定制化的弱口令。

用户口令强度校验机制是否开启由参数password\_policy控制，当该参数设置为1时表示采用密码复杂度校验，默认值为1。

## 数据加密存储<a name="section13800339194113"></a>

提供对插入数据进行加密存储。

为用户提供数据加解密接口，针对用户识别的敏感信息列使用加密函数，使数据加密后再存储在表内。

当用户需要对整张表进行加密存储处理时，则需要为每一列单独书写加密函数，不同的属性列可使用不同的入参。

当具有对应权限的用户需要查看具体数据时，可通过解密函数接口对相应的属性列进行解密处理。

## 账本数据库<a name="section185956502478"></a>

为了防止数据库运维人员可能存在监守自盗、篡改数据库并擦除痕迹等行为，可以利用账本数据库特性来进行更加全面的审计和追溯历史。在修改防篡改用户表数据时，数据库会将修改行为记录至只可追加数据的历史表中，从而达到记录操作历史和操作溯源的能力。

账本数据库通过生成数据hash摘要的方式来保存和验证历史操作。账本指的是用户历史表和全局区块表，对于表级别数据修改操作，系统将操作信息以及hash摘要记录至全局区块表中，同时每个防篡改用户表对应一个用户历史表来记录行级数据变更的hash摘要。用户可以通过重新计算hash摘要、验证hash摘要一致等方式判断防篡改用户表是否被篡改。

账本中的每条记录代表一条已经发生了的既定操作事实，其内容只可追加不可修改，通过对防篡改用户表和相应历史表进行一致性校验可以实现对篡改行为的识别和追踪溯源。此外，账本数据库提供了防篡改用户表一致性校验接口、历史表恢复和归档接口以满足篡改识别、数据膨胀消减、历史数据修复归档等需求。

