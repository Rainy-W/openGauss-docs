# 特性介绍<a name="ZH-CN_TOPIC_0000001201007180"></a>

## cm\_agent<a name="section1669543664312"></a>

cm\_agent是部署在数据库每个主机上，用来启停和监控各个数据库实例进程的数据库管理组件。

主要功能有：

-   数据库实例启动和停止时负责拉起和停止本主机上部署的实例进程。
-   监控本主机上运行的实例状态并将状态上报发送给CM Server。
-   执行CM Server仲裁下发的命令。

**命令说明**：

-   公共选项：
    -   -V, --version

        打印cm\_agent版本信息，然后退出。

    -   -?, -h,--help

        显示关于cm\_agent命令行参数的帮助信息，然后退出。


-   日志信息记录的位置选项：
    -   0

        记录在设定的日志文件中。

    -   1

        记录在syslog文件中。

    -   2

        记录在设定的日志文件中。

    -   3

        空文件，即不记录日志信息。


-   启动模式选项：
    -   normal

        正常模式启动。

    -   abnormal

        非正常模式启动。



## cm\_server<a name="section132815414420"></a>

cm\_server是用来进行数据库实例管理和实例仲裁的组件。主要功能有：

-   接收各个节点上cm\_agent发送的数据库各实例状态。
-   提供数据库实例整体状态的查询功能。
-   监控实例的状态变化并进行仲裁命令的下发。

**命令说明**：

-   公共选项：
    -   -V, --version

        打印cm\_server版本信息，然后退出。

    -   -?, -h,--help

        显示关于cm\_server命令行参数的帮助信息，然后退出。


-   日志信息记录的位置选项：
    -   0

        记录在设定的日志文件中。

    -   1

        记录在syslog文件中。

    -   2

        记录在设定的日志文件中。

    -   3

        空文件，即不记录日志信息。



## 自定义资源<a name="section43117352044"></a>

-   资源配置

    资源配置文件cm\_resource.json，文件包含所有自定义资源的相关属性，可以通过cm\_ctl res命令对配置文件修改。不支持动态生效，修改配置文件后需要重启cm才能生效。

-   客户端

    CM提供客户端动态库给资源进行集成，提供集群状态查询、状态变更通知、集群锁能力。

-   自动启停资源

    资源需要提供脚本，脚本包含启停、检测等能力，脚本路径需要配置在资源配置文件中。

-   手动启停资源

    可以通过cm\_ctl start/stop -n -I命令实现资源实例的启停操作，详细参见  [工具介绍](cm_ctl工具介绍.md)。

-   自定义资源状态

    自定义资源有三种状态：online，offline，deleted，unknown。可以通过cm\_ctl查询。


## 共享存储<a name="section135462412052"></a>

-   磁盘心跳

    各节点cm\_agent定时向投票盘写入心跳，cm\_server获取投票盘中的磁盘心跳，作为主备共享模式下的仲裁依据。

-   网络心跳

    节点间的连通性网络心跳检测的主逻辑在cma实现。为了避免频繁建连，心跳采用长连接的方式，即cma之间通过TCP长连接，进行心跳交互，由每个cma节点定时广播，并周期性将列表信息上报给cms，此功能依赖各个节点的时钟完全同步。

-   仲裁最大集群

    cms根据网络心跳数据、磁盘心跳数据、共享盘状态等进行仲裁，选主子集群。

    子集群满足条件：

    1. 实例正常；

    2. 相互网络通信正常；

    3. 磁盘心跳正常；

    不满足条件的剔除集群。

    子集群仲裁规则：

    1. 拥有节点多的子集群胜出；

    2. 如果节点数一样多，则节点号小的胜出。

-   约束：
    -   集群节点时钟同步。
    -   CM使用的共享盘在安装之前请确保至少150M为空，否则可能会有历史数据影响。
    -   CM使用的投票盘在安装之前请确保已清空，否则可能会有历史数据影响。
    -   由于心跳是集群所有节点间进行的，在大集群的情况下可能会对网络产生一定影响，因此，最多只会启动64个节点的心跳检测（DMS最多只支持64节点，满足使用要求）。
    -   由于CM集群规模最多只支持8个备机，因此当前部署最多支持9副本的集群。
    -   Voting disk和share disk确保包括至少1G空间，由CM独占，其他应用不能使用。
    -   在共享存储架构仲裁模式下，才启用磁盘心跳。


## CM支持DN仲裁<a name="section2099617234715"></a>

-   CM支持的DN仲裁模式主要分为：
    -   Quorum 模式：基于多数派模式仲裁，选出同步备
        -   简介：CM 基于Quorum模式进行仲裁，当DN分片处于无主场景时，CM在多数派DN redo完成后，选择 term和lsn最大的节点\(同步备\)发送failover升主。
        -   约束：最小满足一主两备集群

    -   DCF 模式：
        -   自动选主模式：基于paxos 协议：
            -   简介：dcf模式自动选主，在此场景下，CM不再进行对DN选主，只负责数据采集，假死检测等。
            -   约束：switchover只能使用cm\_ctl switchover -n NODEID -D DATADIR
            -   CM配置：enable\_dcf=ON、dn\_arbitrate\_mode=paxos
            -   DN配置：enable\_dcf=ON

        -   总体约束：
            -   最小满足一主两备集群

        -   默认安装：DCF自动选主模式

    -   共享存储模式：
        -   简介：在此场景下，CM不再进行对DN选主，只负责数据采集，假死检测等。
        -   CM配置：dn\_arbitrate\_mode=share\_disk
        -   介绍和约束：参考[共享存储](#section135462412052)



