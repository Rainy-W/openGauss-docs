# 增量迁移<a name="ZH-CN_TOPIC_0000001347292416"></a>

## 功能介绍<a name="section41999541027"></a>

增量迁移是指将mysql数据迁移期间（包括全量和增量迁移）产生的增量数据迁移至openGauss端。

## 原理简介<a name="section75651553269"></a>

基于开源三方件mysql-binlog-connector-java解析mysql的binlog，并根据mysql主备并行复制的原理，对可并行的事务在openGauss端采用多线程进行并行回放，以实现MySQL到openGauss端的在线迁移。其中并行事务的判断规则为：如果所有正在回放的事务的最小sequence\_number大于该事务的last\_committed，那么该事务就可以并行执行。该方案可以严格保证事务的顺序和一致性。

## 特性优势<a name="section2124757135"></a>

利用sysbench对mysql进行压测，在10张表30个线程并发情况下，针对IUD混合场景，在Kunpeng-920 2p openEuler机器上测试，整体在线迁移性能可达3w tps。

**表 1**  在线迁移性能说明

<a name="table134637139277"></a>
<table><thead align="left"><tr id="row146311362719"><th class="cellrowborder" valign="top" width="27.224555088982207%" id="mcps1.2.7.1.1"><p id="p1246321320273"><a name="p1246321320273"></a><a name="p1246321320273"></a>lua模型</p>
</th>
<th class="cellrowborder" valign="top" width="15.006998600279944%" id="mcps1.2.7.1.2"><p id="p84635138276"><a name="p84635138276"></a><a name="p84635138276"></a>num-threads</p>
</th>
<th class="cellrowborder" valign="top" width="16.95660867826435%" id="mcps1.2.7.1.3"><p id="p4463171316273"><a name="p4463171316273"></a><a name="p4463171316273"></a>oltp-tables-count</p>
</th>
<th class="cellrowborder" valign="top" width="15.396920615876825%" id="mcps1.2.7.1.4"><p id="p84635135270"><a name="p84635135270"></a><a name="p84635135270"></a>oltp-table-size</p>
</th>
<th class="cellrowborder" valign="top" width="10.367926414717058%" id="mcps1.2.7.1.5"><p id="p2463161313273"><a name="p2463161313273"></a><a name="p2463161313273"></a>max-time</p>
</th>
<th class="cellrowborder" valign="top" width="15.046990601879623%" id="mcps1.2.7.1.6"><p id="p04641131271"><a name="p04641131271"></a><a name="p04641131271"></a>speed（w/tps）</p>
</th>
</tr>
</thead>
<tbody><tr id="row16464101314272"><td class="cellrowborder" valign="top" width="27.224555088982207%" headers="mcps1.2.7.1.1 "><p id="p1246441312716"><a name="p1246441312716"></a><a name="p1246441312716"></a>insert.lua带主键</p>
</td>
<td class="cellrowborder" valign="top" width="15.006998600279944%" headers="mcps1.2.7.1.2 "><p id="p94641413142719"><a name="p94641413142719"></a><a name="p94641413142719"></a>30</p>
</td>
<td class="cellrowborder" valign="top" width="16.95660867826435%" headers="mcps1.2.7.1.3 "><p id="p84641613112711"><a name="p84641613112711"></a><a name="p84641613112711"></a>10</p>
</td>
<td class="cellrowborder" valign="top" width="15.396920615876825%" headers="mcps1.2.7.1.4 "><p id="p15464191319278"><a name="p15464191319278"></a><a name="p15464191319278"></a>1000</p>
</td>
<td class="cellrowborder" valign="top" width="10.367926414717058%" headers="mcps1.2.7.1.5 "><p id="p10464111342719"><a name="p10464111342719"></a><a name="p10464111342719"></a>50</p>
</td>
<td class="cellrowborder" valign="top" width="15.046990601879623%" headers="mcps1.2.7.1.6 "><p id="p124647131273"><a name="p124647131273"></a><a name="p124647131273"></a>3.447</p>
</td>
</tr>
<tr id="row646414137271"><td class="cellrowborder" valign="top" width="27.224555088982207%" headers="mcps1.2.7.1.1 "><p id="p146441372713"><a name="p146441372713"></a><a name="p146441372713"></a>insert.lua带主键</p>
</td>
<td class="cellrowborder" valign="top" width="15.006998600279944%" headers="mcps1.2.7.1.2 "><p id="p11464121312279"><a name="p11464121312279"></a><a name="p11464121312279"></a>50</p>
</td>
<td class="cellrowborder" valign="top" width="16.95660867826435%" headers="mcps1.2.7.1.3 "><p id="p346461314272"><a name="p346461314272"></a><a name="p346461314272"></a>10</p>
</td>
<td class="cellrowborder" valign="top" width="15.396920615876825%" headers="mcps1.2.7.1.4 "><p id="p18464111311276"><a name="p18464111311276"></a><a name="p18464111311276"></a>1000</p>
</td>
<td class="cellrowborder" valign="top" width="10.367926414717058%" headers="mcps1.2.7.1.5 "><p id="p1464111318270"><a name="p1464111318270"></a><a name="p1464111318270"></a>50</p>
</td>
<td class="cellrowborder" valign="top" width="15.046990601879623%" headers="mcps1.2.7.1.6 "><p id="p1146431322719"><a name="p1146431322719"></a><a name="p1146431322719"></a>3.934</p>
</td>
</tr>
<tr id="row1346431342713"><td class="cellrowborder" valign="top" width="27.224555088982207%" headers="mcps1.2.7.1.1 "><p id="p84643135273"><a name="p84643135273"></a><a name="p84643135273"></a>insert.lua带主键</p>
</td>
<td class="cellrowborder" valign="top" width="15.006998600279944%" headers="mcps1.2.7.1.2 "><p id="p2464113162713"><a name="p2464113162713"></a><a name="p2464113162713"></a>30</p>
</td>
<td class="cellrowborder" valign="top" width="16.95660867826435%" headers="mcps1.2.7.1.3 "><p id="p0464113192714"><a name="p0464113192714"></a><a name="p0464113192714"></a>50</p>
</td>
<td class="cellrowborder" valign="top" width="15.396920615876825%" headers="mcps1.2.7.1.4 "><p id="p2464191382715"><a name="p2464191382715"></a><a name="p2464191382715"></a>1000</p>
</td>
<td class="cellrowborder" valign="top" width="10.367926414717058%" headers="mcps1.2.7.1.5 "><p id="p54647135275"><a name="p54647135275"></a><a name="p54647135275"></a>50</p>
</td>
<td class="cellrowborder" valign="top" width="15.046990601879623%" headers="mcps1.2.7.1.6 "><p id="p3464121311274"><a name="p3464121311274"></a><a name="p3464121311274"></a>3.216</p>
</td>
</tr>
<tr id="row84641313162712"><td class="cellrowborder" valign="top" width="27.224555088982207%" headers="mcps1.2.7.1.1 "><p id="p246420134276"><a name="p246420134276"></a><a name="p246420134276"></a>insert.lua带主键</p>
</td>
<td class="cellrowborder" valign="top" width="15.006998600279944%" headers="mcps1.2.7.1.2 "><p id="p134642013182713"><a name="p134642013182713"></a><a name="p134642013182713"></a>30</p>
</td>
<td class="cellrowborder" valign="top" width="16.95660867826435%" headers="mcps1.2.7.1.3 "><p id="p12464913132717"><a name="p12464913132717"></a><a name="p12464913132717"></a>10</p>
</td>
<td class="cellrowborder" valign="top" width="15.396920615876825%" headers="mcps1.2.7.1.4 "><p id="p846441392718"><a name="p846441392718"></a><a name="p846441392718"></a>10000</p>
</td>
<td class="cellrowborder" valign="top" width="10.367926414717058%" headers="mcps1.2.7.1.5 "><p id="p246414138272"><a name="p246414138272"></a><a name="p246414138272"></a>50</p>
</td>
<td class="cellrowborder" valign="top" width="15.046990601879623%" headers="mcps1.2.7.1.6 "><p id="p1146515138279"><a name="p1146515138279"></a><a name="p1146515138279"></a>3.496</p>
</td>
</tr>
<tr id="row17465181315276"><td class="cellrowborder" valign="top" width="27.224555088982207%" headers="mcps1.2.7.1.1 "><p id="p54651613142712"><a name="p54651613142712"></a><a name="p54651613142712"></a>insert.lua带主键</p>
</td>
<td class="cellrowborder" valign="top" width="15.006998600279944%" headers="mcps1.2.7.1.2 "><p id="p03331029183111"><a name="p03331029183111"></a><a name="p03331029183111"></a>30</p>
</td>
<td class="cellrowborder" valign="top" width="16.95660867826435%" headers="mcps1.2.7.1.3 "><p id="p11333132943111"><a name="p11333132943111"></a><a name="p11333132943111"></a>10</p>
</td>
<td class="cellrowborder" valign="top" width="15.396920615876825%" headers="mcps1.2.7.1.4 "><p id="p20465161315275"><a name="p20465161315275"></a><a name="p20465161315275"></a>1000</p>
</td>
<td class="cellrowborder" valign="top" width="10.367926414717058%" headers="mcps1.2.7.1.5 "><p id="p1846531382718"><a name="p1846531382718"></a><a name="p1846531382718"></a>100</p>
</td>
<td class="cellrowborder" valign="top" width="15.046990601879623%" headers="mcps1.2.7.1.6 "><p id="p1465613202712"><a name="p1465613202712"></a><a name="p1465613202712"></a>3.294</p>
</td>
</tr>
<tr id="row746520132273"><td class="cellrowborder" valign="top" width="27.224555088982207%" headers="mcps1.2.7.1.1 "><p id="p1046551317279"><a name="p1046551317279"></a><a name="p1046551317279"></a>insert.lua不带主键</p>
</td>
<td class="cellrowborder" valign="top" width="15.006998600279944%" headers="mcps1.2.7.1.2 "><p id="p121591930143118"><a name="p121591930143118"></a><a name="p121591930143118"></a>30</p>
</td>
<td class="cellrowborder" valign="top" width="16.95660867826435%" headers="mcps1.2.7.1.3 "><p id="p6159163011313"><a name="p6159163011313"></a><a name="p6159163011313"></a>10</p>
</td>
<td class="cellrowborder" valign="top" width="15.396920615876825%" headers="mcps1.2.7.1.4 "><p id="p11465181302718"><a name="p11465181302718"></a><a name="p11465181302718"></a>1000</p>
</td>
<td class="cellrowborder" valign="top" width="10.367926414717058%" headers="mcps1.2.7.1.5 "><p id="p94651113142716"><a name="p94651113142716"></a><a name="p94651113142716"></a>50</p>
</td>
<td class="cellrowborder" valign="top" width="15.046990601879623%" headers="mcps1.2.7.1.6 "><p id="p1046521302717"><a name="p1046521302717"></a><a name="p1046521302717"></a>3.805</p>
</td>
</tr>
<tr id="row74656131270"><td class="cellrowborder" valign="top" width="27.224555088982207%" headers="mcps1.2.7.1.1 "><p id="p74656132273"><a name="p74656132273"></a><a name="p74656132273"></a>update_non_index.lua</p>
</td>
<td class="cellrowborder" valign="top" width="15.006998600279944%" headers="mcps1.2.7.1.2 "><p id="p199128308315"><a name="p199128308315"></a><a name="p199128308315"></a>30</p>
</td>
<td class="cellrowborder" valign="top" width="16.95660867826435%" headers="mcps1.2.7.1.3 "><p id="p19912193023115"><a name="p19912193023115"></a><a name="p19912193023115"></a>10</p>
</td>
<td class="cellrowborder" valign="top" width="15.396920615876825%" headers="mcps1.2.7.1.4 "><p id="p6465101312714"><a name="p6465101312714"></a><a name="p6465101312714"></a>10000</p>
</td>
<td class="cellrowborder" valign="top" width="10.367926414717058%" headers="mcps1.2.7.1.5 "><p id="p12465101314273"><a name="p12465101314273"></a><a name="p12465101314273"></a>50</p>
</td>
<td class="cellrowborder" valign="top" width="15.046990601879623%" headers="mcps1.2.7.1.6 "><p id="p2465161352713"><a name="p2465161352713"></a><a name="p2465161352713"></a>2.531</p>
</td>
</tr>
<tr id="row9465171392713"><td class="cellrowborder" valign="top" width="27.224555088982207%" headers="mcps1.2.7.1.1 "><p id="p17465313162714"><a name="p17465313162714"></a><a name="p17465313162714"></a>update_index.lua</p>
</td>
<td class="cellrowborder" valign="top" width="15.006998600279944%" headers="mcps1.2.7.1.2 "><p id="p1075117313312"><a name="p1075117313312"></a><a name="p1075117313312"></a>30</p>
</td>
<td class="cellrowborder" valign="top" width="16.95660867826435%" headers="mcps1.2.7.1.3 "><p id="p1175117316319"><a name="p1175117316319"></a><a name="p1175117316319"></a>10</p>
</td>
<td class="cellrowborder" valign="top" width="15.396920615876825%" headers="mcps1.2.7.1.4 "><p id="p3466181314272"><a name="p3466181314272"></a><a name="p3466181314272"></a>10000</p>
</td>
<td class="cellrowborder" valign="top" width="10.367926414717058%" headers="mcps1.2.7.1.5 "><p id="p15466181318278"><a name="p15466181318278"></a><a name="p15466181318278"></a>50</p>
</td>
<td class="cellrowborder" valign="top" width="15.046990601879623%" headers="mcps1.2.7.1.6 "><p id="p114661513142719"><a name="p114661513142719"></a><a name="p114661513142719"></a>2.591</p>
</td>
</tr>
<tr id="row16466201322717"><td class="cellrowborder" valign="top" width="27.224555088982207%" headers="mcps1.2.7.1.1 "><p id="p74661413142715"><a name="p74661413142715"></a><a name="p74661413142715"></a>delete.lua</p>
</td>
<td class="cellrowborder" valign="top" width="15.006998600279944%" headers="mcps1.2.7.1.2 "><p id="p5530163273119"><a name="p5530163273119"></a><a name="p5530163273119"></a>30</p>
</td>
<td class="cellrowborder" valign="top" width="16.95660867826435%" headers="mcps1.2.7.1.3 "><p id="p1253063243112"><a name="p1253063243112"></a><a name="p1253063243112"></a>10</p>
</td>
<td class="cellrowborder" valign="top" width="15.396920615876825%" headers="mcps1.2.7.1.4 "><p id="p154661131278"><a name="p154661131278"></a><a name="p154661131278"></a>100000</p>
</td>
<td class="cellrowborder" valign="top" width="10.367926414717058%" headers="mcps1.2.7.1.5 "><p id="p946611316273"><a name="p946611316273"></a><a name="p946611316273"></a>5</p>
</td>
<td class="cellrowborder" valign="top" width="15.046990601879623%" headers="mcps1.2.7.1.6 "><p id="p3466613152711"><a name="p3466613152711"></a><a name="p3466613152711"></a>1.8847</p>
</td>
</tr>
<tr id="row746631332718"><td class="cellrowborder" valign="top" width="27.224555088982207%" headers="mcps1.2.7.1.1 "><p id="p104661413122717"><a name="p104661413122717"></a><a name="p104661413122717"></a>混合(insert + update + delete)</p>
</td>
<td class="cellrowborder" valign="top" width="15.006998600279944%" headers="mcps1.2.7.1.2 "><p id="p153341733193119"><a name="p153341733193119"></a><a name="p153341733193119"></a>28/1/1</p>
</td>
<td class="cellrowborder" valign="top" width="16.95660867826435%" headers="mcps1.2.7.1.3 "><p id="p1733423393110"><a name="p1733423393110"></a><a name="p1733423393110"></a>10</p>
</td>
<td class="cellrowborder" valign="top" width="15.396920615876825%" headers="mcps1.2.7.1.4 "><p id="p74662137279"><a name="p74662137279"></a><a name="p74662137279"></a>1000</p>
</td>
<td class="cellrowborder" valign="top" width="10.367926414717058%" headers="mcps1.2.7.1.5 "><p id="p2046618133277"><a name="p2046618133277"></a><a name="p2046618133277"></a>50</p>
</td>
<td class="cellrowborder" valign="top" width="15.046990601879623%" headers="mcps1.2.7.1.6 "><p id="p18466111372712"><a name="p18466111372712"></a><a name="p18466111372712"></a>3.380</p>
</td>
</tr>
</tbody>
</table>

## 操作步骤<a name="section102376152046"></a>

1.  执行如下命令在[代码仓库](https://gitee.com/opengauss/openGauss-tools-onlineMigration-mysql)下载源码。

    ```
    git clone https://gitee.com/opengauss/openGauss-tools-onlineMigration-mysql.git
    ```

2.  修改配置文件。配置文件的路径为openGauss-tools-onlineMigration-mysql/mysql2openGauss/src/main/resources/config.yml。

    配置文件示例如下：

    ```
    #openGauss config
    openGauss_conn:  
      host: "127.0.0.1"  
      port: "5432"  
      user: "opengauss"  
      password: "password123"  
      database: "postgres" 
    
    #mysql config
    mysql_conn:  
      host: "127.0.0.1"  
      port: "3306"  
      user: "mysql"  
      password: "password123"  
      database: "mysql"
    ```

3.  编译命令。

    ```
    cd openGauss-tools-onlineMigration-mysql/mysql2openGauss/
    mvn clean package
    ```

4.  运行命令。

    ```
    java -jar ./target/online-migration-mysql-1.0-SNAPSHOT.jar
    ```

5.  高性能运行命令。在Kunpeng-920 2p openEuler机器上执行如下命令。

    ```
    numactl -C 0-31 -m 0 java -Xms15G -Xmx25G -jar ./target/online-migration-mysql-1.0-SNAPSHOT.jar
    ```


## 注意事项<a name="section146019322411"></a>

-   仅支持从MySQL迁移至openGauss，支持DML迁移，不支持DDL迁移。
-   为保证事务的顺序和一致性，不支持skip\_event, limit\_table, skip\_table等设置。
-   MySQL需要5.7及以上版本。
-   MySQL参数设置要求为：log\_bin=ON, binlog\_format=ROW, binlog\_row\_image=FULL, gtid\_mode = ON。
-   先进行全量迁移，再进行增量迁移，全量迁移可基于[chameleon](https://gitee.com/opengauss/openGauss-tools-chameleon)工具完成。

