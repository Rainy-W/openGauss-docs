# 企业级增强特性<a name="ZH-CN_TOPIC_0241663021"></a>

## 数据分区<a name="section829318456016"></a>

数据分区是数据库产品普遍具备的功能。在openGauss中，数据分区是对数据按照用户指定的策略对数据做的水平分表，将表按照指定范围划分为多个数据互不重叠的部分（Partition）。

openGauss支持范围分区（Range Partitioning）功能，即根据表的一列或者多列，将要插入表的记录分为若干个范围（这些范围在不同的分区里没有重叠），然后为每个范围创建一个分区，用来存储相应的数据。用户在CREATE TABLE时增加PARTITION参数，即表示针对此表应用数据分区功能。

例如，[表1](#zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_t77b9e09809f742f1aaadea05d041bc23)描述了一个xDR（详单）场景下，基于时间分片的方式分区后带来的收益。

**表 1**  分区收益

<a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_t77b9e09809f742f1aaadea05d041bc23"></a>
<table><thead align="left"><tr id="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_r136f4522bccc4ec8ac473a07709c0737"><th class="cellrowborder" valign="top" width="50%" id="mcps1.2.3.1.1"><p id="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_a69f8255bc7d34e4185e6717b1a361ba7"><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_a69f8255bc7d34e4185e6717b1a361ba7"></a><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_a69f8255bc7d34e4185e6717b1a361ba7"></a>场景描述</p>
</th>
<th class="cellrowborder" valign="top" width="50%" id="mcps1.2.3.1.2"><p id="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_ab0bae0f8c2854331bb3a9ea8850c7098"><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_ab0bae0f8c2854331bb3a9ea8850c7098"></a><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_ab0bae0f8c2854331bb3a9ea8850c7098"></a>收益</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_rdfb6ee78653a46059253db9ed1e35114"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_adb10431fb35a4efcb1962ceaa08d2369"><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_adb10431fb35a4efcb1962ceaa08d2369"></a><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_adb10431fb35a4efcb1962ceaa08d2369"></a>当表中访问率较高的行位于一个单独分区或少数几个分区时。</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_zh-cn_topic_0058967181_p879553720320"><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_zh-cn_topic_0058967181_p879553720320"></a><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_zh-cn_topic_0058967181_p879553720320"></a>大幅减少搜索空间，从而提升访问性能。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_r7ddefafe50e44ec0bddd409e82ecafa5"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_a049e1cf48ef14aab929bae5a6eb6f5b5"><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_a049e1cf48ef14aab929bae5a6eb6f5b5"></a><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_a049e1cf48ef14aab929bae5a6eb6f5b5"></a>当需要查询或更新一个分区的大部分记录时。</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_a7c16696dbe2e458f99e643fb98adc6d1"><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_a7c16696dbe2e458f99e643fb98adc6d1"></a><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_a7c16696dbe2e458f99e643fb98adc6d1"></a>仅需要连续扫描对应分区，而非扫描整个表，因此可大幅提升性能。</p>
</td>
</tr>
<tr id="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_r569c0fbda7794f0b9d7c2f11ab573eab"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_af0999fe5959042b491df03f64c3d0c5c"><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_af0999fe5959042b491df03f64c3d0c5c"></a><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_af0999fe5959042b491df03f64c3d0c5c"></a>当需要大量加载或者删除的记录位于一个单独分区或少数几个分区时。</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_a291f441f2f6641899273e4c8920a33e2"><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_a291f441f2f6641899273e4c8920a33e2"></a><a name="zh-cn_topic_0237080621_zh-cn_topic_0231764089_zh-cn_topic_0059777656_a291f441f2f6641899273e4c8920a33e2"></a>可直接读取或删除对应分区，从而提升处理性能；同时由于避免大量零散的删除操作，可减少清理碎片工作量。</p>
</td>
</tr>
</tbody>
</table>

数据分区带来的好处在于：

-   **改善可管理性：**利用分区，可以将表和索引划分为一些更小、更易管理的单元。这样，数据库管理员在进行数据管理时就能采取“分而治之”的方法。 有了分区，维护操作可以专门针对表的特定部分执行。
-   **可提升删除操作的性能：**删除数据时可以删除整个分区，与分别删除每行相比，这种操作非常高效和快速。

    删除分区表与删除普通表的语法一致，都是通过DROP TABLE语法进行删除。

-   **改善查询性能：**通过限制要检查或操作的数据数量，分区可带来许多性能优势。

    分区剪枝：分区剪枝（也称为分区消除）是openGauss在执行时过滤掉不需要扫描的分区，只对相关的分区进行扫描的技术。分区剪枝通常可以将查询性能提高若干数量级。

-   **智能化分区联接：**通过使用一种称为智能化分区联接的技术，分区还可以改善多表联接的性能。当将两个表联接在一起，并且至少其中一个表使用联接键进行分区时，可以应用智能化分区联接。智能化分区联接将一个大型联接分为多个较小的联接，这些较小的联接包含与联接的表“相同”的数据集。这里，“相同”定义为恰好包含联接的两端中相同的分区键值集，因此可以确保只有这些“相同”数据集的联接才会有效，而不必考虑其他数据集。

## 向量化执行和行列混合引擎<a name="section118111201716"></a>

在大宽表，数据量比较大、查询经常关注某些列的场景中，行存储引擎查询性能比较差。例如气象局的场景，单表有200\~800个列，查询经常访问10个列，在类似这样的场景下，向量化执行技术和列存储引擎可以极大的提升性能和减少存储空间。

-   向量化执行

    标准的迭代器模型如[图1](#zh-cn_topic_0237080624_zh-cn_topic_0231764690_zh-cn_topic_0059777898_f9d90aebe179a40759039d0263492489d)所示。控制流向下（下图实线）、数据流向上（下图虚线）、上层驱动下层（上层节点调用下层节点要数据）、一次一元组（下层节点每次只返回一条元组给上层节点）。

    而向量化执行相对于传统的执行模式改变是对于一次一元组的模型修改为一次一批元组，配合列存特性，可以带来巨大的性能提升。

    **图 1**  向量化执行引擎<a name="zh-cn_topic_0237080624_zh-cn_topic_0231764690_zh-cn_topic_0059777898_f9d90aebe179a40759039d0263492489d"></a>  
    

    ![](figures/向量化执行引擎(png).png)

-   行列混合存储引擎

    openGauss支持行存储和列存储两种存储模型，用户可以根据应用场景，建表的时候选择行存储还是列存储表。

    一般情况下，如果表的字段比较多（大宽表），查询中涉及到的列不很多的情况下，适合列存储。如果表的字段个数比较少，查询大部分字段，那么选择行存储比较好。

    如[图2](#zh-cn_topic_0237080624_zh-cn_topic_0231764690_zh-cn_topic_0059777898_fbb2af39ce12a419cb437829aaf1cf4fb)所示，行列混合存储引擎可以同时为用户提供更优的数据压缩比（列存）、更好的索引性能（列存）、更好的点更新和点查询（行存）性能。

    **图 2**  行列混存引擎<a name="zh-cn_topic_0237080624_zh-cn_topic_0231764690_zh-cn_topic_0059777898_fbb2af39ce12a419cb437829aaf1cf4fb"></a>  
    

    <img src="figures/openGauss行列混存引擎.png" style="zoom:50%;" />

    当前列存储引擎有以下约束：

    -   DDL仅支持CREATE/DROP/TRUNCATE TABLE的功能。

        兼容分区的DDL管理功能（如： ADD/DROP/MERGE PARTITION，EXCHANGE功能）。

        支持CREATE TABLE LIKE语法。

        支持ALTER TABLE的部分语法。

        其他功能都不支持。

    -   DML支持UPDATE/COPY/BULKLOAD/DELETE。
    -   不支持触发器，不支持主外键。
    -   支持Psort index、B-tree index和GIN index，具体约束参见《开发者指南》中“SQL参考 \> SQL语法 \> CREATE INDEX”章节。

-   列存下的数据压缩

    对于非活跃的早期数据可以通过压缩来减少空间占用，降低采购和运维成本。

    openGauss列存储压缩支持Delta Value Encoding、Dictionary、RLE 、LZ4、ZLIB等压缩算法，且能够根据数据特征自适应的选择压缩算法，平均压缩比7:1。压缩数据可直接访问，对业务透明，极大缩短历史数据访问的准备时间。


## 高可靠事务处理<a name="section975313598411"></a>

openGauss提供事务管理功能，保证事务的ACID特性。

为了在主节点出现故障时尽可能地不中断服务，openGauss提供了主备双机高可靠机制。通过保护关键用户程序对外不间断提供服务，把因为硬件、软件和人为造成的故障对业务的影响程度降到最低，以保证业务的持续性。

**故障恢复**

支持节点故障可恢复及恢复后满足ACID特性。节点故障、停止后重启等情况下，openGauss能够保证故障之前的数据无丢失，满足ACID特性。

**事务管理：**

-   支持事务块，用户可以通过start transaction命令显式启动一个事务块。
-   支持单语句事务，用户不显式启动事务，则单条语句就是一个事务。

## 高并发&高性能<a name="section137793812513"></a>

openGauss通过服务器端的线程池，可以支持1W并发链接。通过NUMA化内核数据结构，支持线程亲核性处理，可以支持百万级tpmC。通过页面的高效冷热淘汰，支持T级别大内存缓冲区管理。通过CSN快照，去除快照瓶颈，实现多版本访问，读写互不阻塞。通过增量检查点，避免全页写导致的性能波动，实现业务性能平稳运行。

## SQL自诊断<a name="section10413176262"></a>

通过执行查询对应的explain performance，获得对应执行计划，是一种十分有效的定位查询性能问题的方法。但是这种方法需要修改业务逻辑，同时输出的日志量大，问题定位的效率依赖于人员的经验。SQL自诊断为用户提供了另一种更为高效易用的性能问题定位方法。

在执行作业之前，配置GUC参数resource\_track\_level和resource\_track\_cost，然后运行用户作业，就可以通过查看相关系统视图，获得执行完成的相关查询作业可能存在的性能问题。系统视图中会给出导致性能问题的可能原因，根据这些“性能告警”，参考《开发者指南》中“性能调优 \> SQL调优指南 \> 典型SQL调优点 \> SQL自诊断”章节，就可以对存在性能问题的作业进行调优。

SQL自诊断可以在不影响用户作业，不修改业务逻辑的情况下，诊断出相对准确的性能问题，为用户提供更为易用的性能调优参考。

## 内存表<a name="section1482992711616"></a>

内存表把数据全部缓存在内存中，所有数据访问实现免锁并发，实现数据处理的极致性能，满足实时性严苛要求场景。

## 主备双机<a name="section238711473613"></a>

主备双机支持同步和异步复制，应用可以根据业务场景选择合适的部署方式。同步复制保证数据的高可靠，一般需要一主两备部署，同时对性能有一定影响。异步复制一主一备部署即可，对性能影响小，但异常时可能存在数据丢失。openGauss支持页面损坏的自动修复，在主机页面发生损坏时，能够自动从备机修复损坏页面。openGauss支持备机并行日志恢复，尽量降低主机故障时业务不可用的时间。

同时，如果按照主备模式部署，并打开备机可读功能后，备机将能够提供读操作，但不支持写操作（如建表、插入数据、删除数据等），从而缓解主机上的压力。

