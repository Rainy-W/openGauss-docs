# 数据节点重建过程中重启集群，导致集群启动状态异常<a name="ZH-CN_TOPIC_0291615093"></a>

## 问题现象<a name="section1266494720169"></a>

在一主多备集群或主备从集群部署模式下，对某一数据节点重建，在此过程中，重启集群，该数据节点状态为Pending Starting，其余数据节点状态为Pending Need Repair，无法仲裁出主备，状态为Pending Starting的数据节点产生大量无法接受业务连接的日志。

```
redo minRecoveryPoint at 2/321C31C0; backupStartPoint at 1/C13075B0; backupEndRequired FALSE LOG:  redo starts at 1/C5F9D820 LOG:  invalid record length at 2/2170F700: wanted 32, got 0 FATAL:  the database system is starting up FATAL:  the database system is starting up FATAL:  the database system is starting up ...
```

## 原因分析<a name="section666411527167"></a>

1.  集群启动过程中，所有数据节点状态是Pending Starting。首先对已有xlog进行REDO，日志分析发现问题数据节点已经REDO到了后一条xlog record，依然没有达到ControlFile里的最小恢复点MinRecovery Point。
2.  问题数据节点在该场景下，无法在REDO过程中通过CheckConsistency检查，无法发信号给PostMaster主线程，进行PM状态机迁移。
3.  集群以归档恢复模式启动，由于状态机无法正常迁移，因此数据节点无法接受连接，CM Agent无法将数据节点的状态设置成Pending Need Repair。
4.  在该问题场景下，CM Server无法仲裁出数据节点的主备，导致数据节点的REDO线程一直循环， 无法接收外部业务请求，报错信息显示如下。

    ```
     FATAL : the database system is starting up
    ```


## 处理办法<a name="section18477195781618"></a>

1.  终止处于Pending Starting状态的数据节点进程，即剔除数据节点。
2.  等待其他处于Pending Need Repair状态的数据节点仲裁出主备，恢复到Primary Normal或Standby Normal状态。
3.  执行如下命令对有问题数据节点进行全量重建，待其重建成功后则问题修复。

    ```
     cm_ctl build -n NODEID -D DATADIR -b full
    ```

    NODEID是节点ID，DATADIR是待重建数据节点的数据目录。


