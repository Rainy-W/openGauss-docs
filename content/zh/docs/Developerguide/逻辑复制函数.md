# 逻辑复制函数<a name="ZH-CN_TOPIC_0289900082"></a>

-   pg\_create\_logical\_replication\_slot\('slot\_name', 'plugin\_name'\)

    描述：创建逻辑复制槽。

    参数说明：

    -   slot\_name

        流复制槽名称。

        取值范围：字符串，不支持除字母，数字，以及（\_?-.）以外的字符。

    -   plugin\_name

        插件名称。

        取值范围：字符串，当前支持mppdb\_decoding。

    返回值类型：name, text

    备注：第一个返回值表示slot\_name，第二个返回值表示该逻辑复制槽解码的起始LSN位置。调用该函数的用户需要具有SYSADMIN权限或具有REPLICATION权限或继承了内置角色gs\_role\_replication的权限。此函数目前只支持在主机调用。

-   pg\_create\_physical\_replication\_slot\('slot\_name', 'isDummyStandby'\)

    描述：创建新的物理复制槽。

    参数说明：

    -   slot\_name

        流复制槽名称。

        取值范围：字符串，不支持除字母，数字，以及（\_?-.）以外的字符。

    -   isDummyStandby

        是否是从从备连接主机创建的复制槽。

        类型：bool。

    返回值类型：name, text

    备注：调用该函数的用户需要具有SYSADMIN权限或具有REPLICATION权限或继承了内置角色gs\_role\_replication的权限。

-   pg\_drop\_replication\_slot\('slot\_name'\)

    描述：删除流复制槽。

    参数说明：

    -   slot\_name

        流复制槽名称。

        取值范围：字符串，不支持除字母，数字，以及（\_?-.）以外的字符。

    返回值类型：void

    备注：调用该函数的用户需要具有SYSADMIN权限或具有REPLICATION权限或继承了内置角色gs\_role\_replication的权限。此函数目前只支持在主机调用。

-   <a name="zh-cn_topic_0283137128_zh-cn_topic_0237121996_li11712645125"></a>pg\_logical\_slot\_peek\_changes\('slot\_name', 'LSN', upto\_nchanges, 'options\_name', 'options\_value'\)

    描述：解码并不推进流复制槽（下次解码可以再次获取本次解出的数据）。

    参数说明：

    -   slot\_name

        流复制槽名称。

        取值范围：字符串，不支持除字母，数字，以及（\_?-.）以外的字符。

    -   LSN

        日志的LSN，表示只解码小于等于此LSN的日志。

        取值范围：字符串（LSN，格式为xlogid/xrecoff），如'1/2AAFC60'。为NULL时表示不对解码截止的日志位置做限制。

    -   upto\_nchanges

        解码条数（包含begin和commit）。假设一共有三条事务，分别包含3、5、7条记录，如果upto\_nchanges为4，那么会解码出前两个事务共8条记录。解码完第二条事务时发现解码条数记录大于等于upto\_nchanges，会停止解码。

        取值范围：非负整数。

        >![](public_sys-resources/icon-note.gif) **说明：** 
        >LSN和upto\_nchanges中任一参数达到限制，解码都会结束。

    -   options：此项为可选参数，由一系列options\_name和options\_value一一对应组成。
        -   include-xids

            解码出的data列是否包含xid信息。

            取值范围：0或1，默认值为1。

            -   0：设为0时，解码出的data列不包含xid信息。
            -   1：设为1时，解码出的data列包含xid信息。

        -   skip-empty-xacts

            解码时是否忽略空事务信息。

            取值范围：0或1，默认值为0。

            -   0：设为0时，解码时不忽略空事务信息。
            -   1：设为1时，解码时会忽略空事务信息。

        -   include-timestamp

            解码信息是否包含commit时间戳。

            取值范围：0或1，默认值为0。

            -   0：设为0时，解码信息不包含commit时间戳。
            -   1：设为1时，解码信息包含commit时间戳。

        -   only-local

            是否仅解码本地日志。

            取值范围：0或1，默认值为1。

            -   0：设为0时，解码非本地日志和本地日志。
            -   1：设为1时，仅解码本地日志。

        -   force-binary

            是否以二进制格式输出解码结果。

            取值范围：0，默认值为0。

            -   0：设为0时，以文本格式输出解码结果。


    返回值类型：text, xid, text

    备注：函数返回解码结果，每一条解码结果包含三列，对应上述返回值类型，分别表示LSN位置、xid和解码内容。

    调用该函数的用户需要具有SYSADMIN权限或具有REPLICATION权限或继承了内置角色gs\_role\_replication的权限。

-   pg\_logical\_slot\_get\_changes\('slot\_name', 'LSN', upto\_nchanges, 'options\_name', 'options\_value'\)

    描述：解码并推进流复制槽。

    参数说明：与pg\_logical\_slot\_peek\_changes一致，详细内容请参见[•pg\_logical\_slot\_peek\_ch...](#zh-cn_topic_0283137128_zh-cn_topic_0237121996_li11712645125)。

    备注：调用该函数的用户需要具有SYSADMIN权限或具有REPLICATION权限或继承了内置角色gs\_role\_replication的权限。此函数目前只支持在主机调用。

-   <a name="li15187162457"></a>pg\_logical\_slot\_peek\_binary\_changes\('slot\_name', 'LSN', upto\_nchanges, 'options\_name', 'options\_value'\)

    描述：以二进制格解码且不推进流复制槽（下次解码可以再次获取本次解出的数据）。

    参数说明：

    -   slot\_name

        流复制槽名称。

        取值范围：字符串，不支持除字母，数字，以及（\_?-.）以外的字符。

    -   LSN

        日志的LSN，表示只解码小于等于此LSN的日志。

        取值范围：字符串（LSN，格式为xlogid/xrecoff），如'1/2AAFC60'。为NULL时表示不对解码截止的日志位置做限制。

    -   upto\_nchanges

        解码条数（包含begin和commit）。假设一共有三条事务，分别包含3、5、7条记录，如果upto\_nchanges为4，那么会解码出前两个事务共8条记录。解码完第二条事务时发现解码条数记录大于等于upto\_nchanges，会停止解码。

        取值范围：非负整数。

        >![](public_sys-resources/icon-note.gif) **说明：** 
        >LSN和upto\_nchanges中任一参数达到限制，解码都会结束。

    -   options：此项为可选参数，由一系列options\_name和options\_value一一对应组成。
        -   include-xids

            解码出的data列是否包含xid信息。

            取值范围：0或1，默认值为1。

            -   0：设为0时，解码出的data列不包含xid信息。
            -   1：设为1时，解码出的data列包含xid信息。

        -   skip-empty-xacts

            解码时是否忽略空事务信息。

            取值范围：0或1，默认值为0。

            -   0：设为0时，解码时不忽略空事务信息。
            -   1：设为1时，解码时会忽略空事务信息。

        -   include-timestamp

            解码信息是否包含commit时间戳。

            取值范围：0或1，默认值为0。

            -   0：设为0时，解码信息不包含commit时间戳。
            -   1：设为1时，解码信息包含commit时间戳。

        -   only-local

            是否仅解码本地日志。

            取值范围：0或1，默认值为1。

            -   0：设为0时，解码非本地日志和本地日志。
            -   1：设为1时，仅解码本地日志。

        -   force-binary

            是否以二进制格式输出解码结果。

            取值范围：0或1，默认值为0，均以二进制格式输出结果。


    返回值类型：text, xid, bytea

    备注：函数返回解码结果，每一条解码结果包含三列，对应上述返回值类型，分别表示LSN位置、xid和二进制格式的解码内容。调用该函数的用户需要具有SYSADMIN权限或具有REPLICATION权限或继承了内置角色gs\_role\_replication的权限。

-   pg\_logical\_slot\_get\_binary\_changes\('slot\_name', 'LSN', upto\_nchanges, 'options\_name', 'options\_value'\)

    描述：以二进制格式解码并推进流复制槽。

    参数说明：与pg\_logical\_slot\_peek\_binary\_changes一致，详细内容请参见[•pg\_logical\_slot\_peek\_bi...](#li15187162457)。

    备注：调用该函数的用户需要具有SYSADMIN权限或具有REPLICATION权限或继承了内置角色gs\_role\_replication的权限。

-   pg\_replication\_slot\_advance \('slot\_name', 'LSN'\)

    描述：直接推进流复制槽到指定LSN，不输出解码结果。

    参数说明：

    -   slot\_name

        流复制槽名称。

        取值范围：字符串，不支持除字母，数字，以及（\_?-.）以外的字符。

    -   LSN

        推进到的日志LSN位置，下次解码时只会输出提交位置比该LSN大的事务结果。如果输入的LSN比当前流复制槽记录的推进位置还要小，则直接返回；如果输入的LSN比当前最新物理日志LSN还要大，则推进到当前最新物理日志LSN。

        取值范围：字符串（LSN，格式为xlogid/xrecoff）。

    返回值类型：name, text

    备注：返回值分别对应slot\_name和实际推进至的LSN。调用该函数的用户需要具有SYSADMIN权限或具有REPLICATION权限或继承了内置角色gs\_role\_replication的权限。此函数目前只支持在主机调用。

-   pg\_get\_replication\_slots

    描述：获取复制槽列表。

    返回值类型：text，text，text，oid，boolean，xid，xid，text，boolean

    示例：

    ```
    openGauss=# select * from pg_get_replication_slots();
     slot_name |     plugin     | slot_type | datoid | active | xmin | catalog_xmin | restart_lsn | dummy_standby
    -----------+----------------+-----------+--------+--------+------+--------------+-------------+---------------
     wkl001    | mppdb_decoding | logical   |  15914 | f      |      |      2079556 | 4/1B81D920  | f
     dn_6002   |                | physical  |      0 | t      |      |              | 8/7CB63BD8  | f
     dn_6004   |                | physical  |      0 | t      |      |              | 8/7CB63BD8  | f
     dn_6003   |                | physical  |      0 | t      |      |              | 8/7CB63BD8  | f
     gfslot001 | mppdb_decoding | logical   |  15914 | f      |      |      2412553 | 4/A54B2428  | f
    (5 rows)
    ```

-   pg_replication_origin_create (node_name)

    描述：用给定的外部名称创建一个复制源，并且返回分配给它的内部ID。

    参数说明：

    node_name

    待创建的复制源的名称

    取值范围：字符串，不支持除字母，数字，以及（\_?-.）以外的字符。

    返回值类型：oid

-   pg_replication_origin_drop (node_name)

    描述：删除一个以前创建的复制源，包括任何相关的重放进度。

    参数说明：

    node_name

    待删除的复制源的名称

    取值范围：字符串，不支持除字母，数字，以及（\_?-.）以外的字符。

-   pg_replication_origin_oid (node_name)

    描述：根据名称查找复制源并返回内部ID。如果没有发现这样的复制源，则抛出错误。

    参数说明：

    node_name

    要查找的复制源的名称

    取值范围：字符串，不支持除字母，数字，以及（\_?-.）以外的字符。

    返回值类型：oid

-   pg_replication_origin_session_setup (node_name)

    描述：将当前会话标记为从给定的原点回放，从而允许跟踪回放进度。只能在当前没有选择原点时使用。使用pg_replication_origin_session_reset 命令来撤销。

    参数说明：

    node_name

    复制源名称

    取值范围：字符串，不支持除字母，数字，以及（\_?-.）以外的字符。

-   pg_replication_origin_session_reset ()

    描述：取消pg_replication_origin_session_setup()的效果。

-   pg_replication_origin_session_is_setup ()

    描述：如果在当前会话中选择了复制源则返回真。

    返回值类型：boolean

-   pg_replication_origin_session_progress (flush)

    描述：返回当前会话中选择的复制源的重放位置。
    
    参数说明：
    
    flush
    
    决定对应的本地事务是否被确保已经刷入磁盘。

    取值范围：boolean

    返回值类型：LSN

-   pg_replication_origin_xact_setup (origin_lsn, origin_timestamp)

    描述：将当前事务标记为重放在给定LSN和时间戳上提交的事务。只能在使用pg_replication_origin_session_setup选择复制源时调用。

    参数说明：
    
    origin_lsn

    复制源回放位置

    取值范围：LSN

    origin_timestamp

    事务提交时间

    取值范围：timestamp with time zone

-   pg_replication_origin_xact_reset ()

    描述：取消pg_replication_origin_xact_setup()的效果。

-   pg_replication_origin_advance (node_name, lsn)

    描述：
    
    将给定节点的复制进度设置为给定的位置。这主要用于设置初始位置，或在配置更改或类似的变更后设置新位置。
    
    **注意**：这个函数的不当使用可能会导致不一致的复制数据。

    参数说明：

    node_name

    已有复制源名称

    取值范围：字符串，不支持除字母，数字，以及（\_?-.）以外的字符。

    lsn

    复制源回放位置

    取值范围：LSN

-   pg_replication_origin_progress (node_name, flush)

    描述：返回给定复制源的重放位置。
    
    参数说明：

    node_name

    复制源名称

    取值范围：字符串，不支持除字母，数字，以及（\_?-.）以外的字符。
    
    flush
    
    决定对应的本地事务是否被确保已经刷入磁盘。

    取值范围：boolean

-   pg_show_replication_origin_status()

    描述：获取复制源的复制状态。

    返回值类型：
    
    local_id, oid, 复制源id

    external_id, text, 复制源名称

    remote_lsn, LSN, 复制源的lsn位置

    local_lsn, LSN, 本地的lsn位置。

-   pg_get_publication_tables(pub_name)

    描述：根据发布的名称，返回对应发布要发布的表的relid列表

    参数说明：

    pub_name

    已存在的发布名称

    取值范围：字符串，不支持除字母，数字，以及（\_?-.）以外的字符。

    返回值类型：relid列表

-   pg_stat_get_subscription(sub_oid oid) → record

    描述：
    
    输入订阅的oid，返回订阅的状态信息。

    参数说明：
    
    subid
    
    订阅的oid

    取值范围：oid

    relid, oid, 表的oid

    pid, thread_id, 后台apply/sync线程的thread id

    received_lsn, pg_lsn, 从发布端接收到的最近的lsn

    last_msg_send_time, timestamp, 最近发布端发送消息的时间

    last_msg_receipt_time, timestamp, 最新订阅端收到消息的时间

    latest_end_lsn, pg_lsn, 最近一次收到保活消息时发布端的lsn

    latest_end_time, timstamp, 最近一次收到保活消息的时间

